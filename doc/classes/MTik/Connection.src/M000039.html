<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>fetch (MTik::Connection)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File lib/mtik/connection.rb, line 489</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">url</span>, <span class="ruby-identifier">filename</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">callback</span>)
    <span class="ruby-identifier">total</span>  = <span class="ruby-identifier">bytes</span> = <span class="ruby-value">0</span>
    <span class="ruby-identifier">status</span> = <span class="ruby-value str">''</span>
    <span class="ruby-identifier">done</span>   = <span class="ruby-keyword kw">false</span>
    <span class="ruby-identifier">req</span> = <span class="ruby-identifier">get_reply_each</span>(
      <span class="ruby-value str">'/tool/fetch'</span>,
      <span class="ruby-value str">'=url='</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">url</span>,
      <span class="ruby-value str">'=dst-path='</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">filename</span>
    ) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">req</span>, <span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-value str">'!re'</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">done</span>
        <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-value str">'status'</span>)
          <span class="ruby-identifier">raise</span> <span class="ruby-constant">MTik</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;Unknown response to '/tool/fetch': missing 'status' in response.&quot;</span>)
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-identifier">status</span> = <span class="ruby-identifier">s</span>[<span class="ruby-value str">'status'</span>]
        <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">status</span>
        <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'downloading'</span>
          <span class="ruby-identifier">total</span> = <span class="ruby-identifier">s</span>[<span class="ruby-value str">'total'</span>].<span class="ruby-identifier">to_i</span>
          <span class="ruby-identifier">bytes</span> = <span class="ruby-identifier">s</span>[<span class="ruby-value str">'downloaded'</span>].<span class="ruby-identifier">to_i</span>
          <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">status</span>, <span class="ruby-identifier">total</span>, <span class="ruby-identifier">bytes</span>)
        <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'connecting'</span>
          <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">status</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>)
        <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'failed'</span>, <span class="ruby-value str">'finished'</span>
          <span class="ruby-identifier">bytes</span> = <span class="ruby-identifier">total</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'finished'</span>
          <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">status</span>, <span class="ruby-identifier">total</span>, <span class="ruby-identifier">bytes</span>)
          <span class="ruby-identifier">done</span> = <span class="ruby-keyword kw">true</span>
          <span class="ruby-comment cmt">## Now terminate the download request (since it's done):</span>
          <span class="ruby-identifier">get_reply</span>(<span class="ruby-value str">'/cancel'</span>, <span class="ruby-value str">'=tag='</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">req</span>.<span class="ruby-identifier">tag</span>) {}
        <span class="ruby-keyword kw">else</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-constant">MTik</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;Unknown status in '/tool/fetch' response: '#{status}'&quot;</span>)
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-value str">'!trap'</span>)
        <span class="ruby-comment cmt">## Pass trap message back (unless finished--in which case we</span>
        <span class="ruby-comment cmt">## ignore the 'interrrupted' trap message):</span>
        <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">s</span>[<span class="ruby-value str">'message'</span>], <span class="ruby-identifier">total</span>, <span class="ruby-identifier">bytes</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">done</span>
      <span class="ruby-keyword kw">end</span>
    <span class="ruby-keyword kw">end</span>
  <span class="ruby-keyword kw">end</span></pre>
</body>
</html>
